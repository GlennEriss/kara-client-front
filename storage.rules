rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==========================================
    // FONCTIONS UTILITAIRES
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && (
        // Vérifier via custom claims (token.role)
        // Inclut Administrateur pour cohérence avec Firestore
        (request.auth.token.role != null && 
         request.auth.token.role in ['Admin', 'SuperAdmin', 'Secretary', 'Administrateur'])
      );
    }
    
    // Vérifie si le fichier est une image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Vérifie si le fichier est un PDF
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    // Limite de taille : 5 MB pour les images
    function isImageSizeValid() {
      return request.resource.size < 5 * 1024 * 1024;
    }
    
    // Limite de taille : 10 MB pour les PDFs
    function isPDFSizeValid() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // Limite de taille : 5 MB pour les contrats CI (conforme à l'UI)
    function isContractPDFSizeValid() {
      return request.resource.size < 5 * 1024 * 1024;
    }
    
    // ==========================================
    // PHOTOS DE PROFIL (MEMBERSHIP-PHOTOS)
    // ==========================================
    // Photos uploadées lors de l'inscription
    
    match /membership-photos/{fileName} {
      // Lecture : Publique (affichage dans le formulaire et admin)
      allow read: if true;
      
      // Écriture : Publique avec validation (image, max 5MB)
      allow write: if isImage() && isImageSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS D'IDENTITÉ (MEMBERSHIP-DOCUMENTS)
    // ==========================================
    // Pièces d'identité recto/verso - DONNÉES SENSIBLES
    // Lecture publique pour permettre les corrections (sécurité gérée via code de sécurité)
    
    match /membership-documents/{requestId}/{fileName} {
      // Lecture : Publique (nécessaire pour les corrections via code de sécurité)
      // La sécurité est gérée côté application via le code de sécurité
      allow read: if true;
      
      // Écriture : Publique avec validation (image, max 5MB)
      // Permet l'upload lors de l'inscription et les corrections
      allow write: if isImage() && isImageSizeValid();
      
      // Suppression : Publique (pour permettre le remplacement lors des corrections)
      // Sécurité gérée côté application via code de sécurité
      allow delete: if true;
    }
    
    // ==========================================
    // PDFs D'ADHÉSION (MEMBERSHIP-ADHESION-PDFS)
    // ==========================================
    // PDFs générés lors de l'approbation - CONFIDENTIELS
    // Supporte les chemins avec sous-dossiers (matricule) : membership-adhesion-pdfs/{matricule}/{fileName}
    
    match /membership-adhesion-pdfs/{allPaths=**} {
      // Lecture : Admins uniquement
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (PDF, max 10MB)
      allow write: if isAdmin() && isPDF() && isPDFSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS GÉNÉRIQUES PAR MODULE
    // ==========================================
    // Chemin pour les documents archivés de chaque module
    
    match /documents/{module}/{memberId}/{fileName} {
      // Lecture : Admin ou propriétaire
      allow read: if isAdmin() || request.auth.uid == memberId;
      
      // Écriture : Admin uniquement
      allow write: if isAdmin();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // PREUVES DE PAIEMENT (PAYMENT-PROOFS)
    // ==========================================
    // Preuves de paiement uploadées par les admins
    // DONNÉES SENSIBLES - Accès restreint
    
    match /payment-proofs/{fileName} {
      // Lecture : Admins uniquement (données sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 5MB)
      allow write: if isAdmin() && isImage() && isImageSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS CONTRATS (CONTRACTS-CI) + CRÉDIT SPÉCIALE
    // ==========================================
    // Contrats signés PDF + preuves de paiement (images) uploadés par les admins
    // Chemin : contracts-ci/{memberId}/{fileName}
    // - Caisse Imprévue : contrats (ADHESION_CI), supports, remboursements
    // - Crédit Spéciale : contrats (CREDIT_SPECIALE_CONTRACT), signés (CREDIT_SPECIALE_CONTRACT_SIGNED), reçus (CREDIT_SPECIALE_RECEIPT)
    // - Page /credit-speciale/demandes/[id] : affichage documentPhotoUrl du contact d'urgence (contracts-ci ou emergency-contacts)
    // - PDF max 5MB, Images max 5MB
    
    match /contracts-ci/{memberId}/{fileName} {
      // Lecture : Admins uniquement (documents sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement - PDF (max 5MB) OU image (max 5MB)
      allow write: if isAdmin() && (
        (isPDF() && isContractPDFSizeValid()) ||
        (isImage() && isImageSizeValid())
      );
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // Preuves de paiement des remboursements CI (Marquer comme payé)
    // Chemin : contracts-ci/refunds/{contractId}/{refundId}/{fileName}
    // Utilisé par : MarkAsPaidRefundCIModal (preuve de paiement, max 20MB)
    
    match /contracts-ci/refunds/{contractId}/{refundId}/{fileName} {
      // Lecture : Admins uniquement (preuves sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 20MB)
      allow write: if isAdmin() && isImage() && request.resource.size < 20 * 1024 * 1024;
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // Photos de pièces d'identité des contacts d'urgence (chemin avec contractId)
    // Chemin : contracts-ci/{memberId}/{contractId}/{fileName}
    
    match /contracts-ci/{memberId}/{contractId}/{fileName} {
      // Lecture : Admins uniquement
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 5MB)
      allow write: if isAdmin() && isImage() && isImageSizeValid();
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // CAISSE SPÉCIALE - PREUVES DE PAIEMENT ET REMBOURSEMENTS
    // ==========================================
    // Preuves de paiement (images) et documents de remboursement
    // Utilisé par : pay(), payGroup(), updatePaymentContribution(), markRefundPaid()
    // Chemins :
    //   - caisse/{contractId}/payments/{paymentId}/{fileName}
    //   - caisse/{contractId}/payments/{paymentId}/contributions/{fileName}
    //   - caisse/{contractId}/refunds/{refundId}/{fileName}
    
    match /caisse/{contractId}/payments/{paymentId}/{fileName} {
      // Lecture : Admins uniquement (preuves sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 5MB)
      allow write: if isAdmin() && isImage() && isImageSizeValid();
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    match /caisse/{contractId}/payments/{paymentId}/contributions/{fileName} {
      // Lecture : Admins uniquement
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 5MB)
      allow write: if isAdmin() && isImage() && isImageSizeValid();
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    match /caisse/{contractId}/refunds/{refundId}/{fileName} {
      // Lecture : Admins uniquement
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement - PDF ou image (max 5MB)
      allow write: if isAdmin() && (
        (isPDF() && isContractPDFSizeValid()) ||
        (isImage() && isImageSizeValid())
      );
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS DE REMBOURSEMENT (CONTRACT-DOCUMENTS)
    // ==========================================
    // PDFs de remboursement final/anticipé uploadés via PdfDocumentModal
    // Utilisé par : StandardContract, DailyContract, FreeContract (remboursements CS)
    // Chemin : contract-documents/{contractId}/{refundId}/{fileName}
    
    match /contract-documents/{contractId}/{refundId}/{fileName} {
      // Lecture : Admins uniquement (documents sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (PDF, max 10MB)
      allow write: if isAdmin() && isPDF() && isPDFSizeValid();
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // CAISSE SPÉCIALE - CONTRATS PDF (PAGE /caisse-speciale)
    // ==========================================
    // PDFs de contrats signés uploadés via ContractPdfUploadModal
    // Chemin : contracts/{contractId}/{fileName}
    
    match /contracts/{contractId}/{fileName} {
      // Lecture : Admins uniquement (documents sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (PDF, max 10MB)
      allow write: if isAdmin() && isPDF() && isPDFSizeValid();
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // CRÉDIT SPÉCIALE - CONTRATS PDF (FALLBACK)
    // ==========================================
    // Chemin alternatif : credit-contracts/{contractId}/{fileName}
    // Utilisé si génération PDF directe (placeholder ou futur)
    
    match /credit-contracts/{contractId}/{fileName} {
      allow read: if isAdmin();
      allow write: if isAdmin() && isPDF() && isPDFSizeValid();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // CAISSE SPÉCIALE - CONTACTS D'URGENCE (DEMANDES)
    // ============================================
    // Photos de pièces d'identité des contacts d'urgence
    // Utilisé par : EmergencyContactForm, EmergencyContactMemberSelector (création contrat CS)
    // Chemin : emergency-contacts/{fileName}
    
    match /emergency-contacts/{fileName} {
      // Lecture : Admins uniquement (documents sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation
      // - Type : image (jpeg, jpg, png, webp)
      // - Taille max : 5 MB
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/(jpeg|jpg|png|webp)') &&
        request.resource.size < 5 * 1024 * 1024;
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ============================================
    // CAISSE IMPRÉVUE - DOCUMENTS CONTACTS D'URGENCE (V2)
    // ============================================
    // Photos de pièces d'identité des contacts d'urgence
    // Chemin : emergency-contacts-ci/{fileName}
    
    match /emergency-contacts-ci/{fileName} {
      // Lecture : Publique (nécessaire pour afficher dans les formulaires et détails)
      // La sécurité est gérée côté application (seuls les admins accèdent)
      allow read: if true;
      
      // Écriture : Admins uniquement avec validation
      // - Type : image (jpeg, jpg, png, webp)
      // - Taille max : 5 MB
      allow write: if isAdmin() && 
        request.resource.contentType.matches('image/(jpeg|jpg|png|webp)') &&
        request.resource.size < 5 * 1024 * 1024;
      
      // Suppression : Admins uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // RÈGLE PAR DÉFAUT
    // ==========================================
    // Refuser tout accès non explicitement autorisé
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
