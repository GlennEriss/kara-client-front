rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==========================================
    // FONCTIONS UTILITAIRES
    // ==========================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.role in ['Admin', 'SuperAdmin', 'Secretary'];
    }
    
    // Vérifie si le fichier est une image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // Vérifie si le fichier est un PDF
    function isPDF() {
      return request.resource.contentType == 'application/pdf';
    }
    
    // Limite de taille : 5 MB pour les images
    function isImageSizeValid() {
      return request.resource.size < 5 * 1024 * 1024;
    }
    
    // Limite de taille : 10 MB pour les PDFs
    function isPDFSizeValid() {
      return request.resource.size < 10 * 1024 * 1024;
    }
    
    // ==========================================
    // PHOTOS DE PROFIL (MEMBERSHIP-PHOTOS)
    // ==========================================
    // Photos uploadées lors de l'inscription
    
    match /membership-photos/{fileName} {
      // Lecture : Publique (affichage dans le formulaire et admin)
      allow read: if true;
      
      // Écriture : Publique avec validation (image, max 5MB)
      allow write: if isImage() && isImageSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS D'IDENTITÉ (MEMBERSHIP-DOCUMENTS)
    // ==========================================
    // Pièces d'identité recto/verso - DONNÉES SENSIBLES
    // Lecture publique pour permettre les corrections (sécurité gérée via code de sécurité)
    
    match /membership-documents/{requestId}/{fileName} {
      // Lecture : Publique (nécessaire pour les corrections via code de sécurité)
      // La sécurité est gérée côté application via le code de sécurité
      allow read: if true;
      
      // Écriture : Publique avec validation (image, max 5MB)
      // Permet l'upload lors de l'inscription et les corrections
      allow write: if isImage() && isImageSizeValid();
      
      // Suppression : Publique (pour permettre le remplacement lors des corrections)
      // Sécurité gérée côté application via code de sécurité
      allow delete: if true;
    }
    
    // ==========================================
    // PDFs D'ADHÉSION (MEMBERSHIP-ADHESION-PDFS)
    // ==========================================
    // PDFs générés lors de l'approbation - CONFIDENTIELS
    // Supporte les chemins avec sous-dossiers (matricule) : membership-adhesion-pdfs/{matricule}/{fileName}
    
    match /membership-adhesion-pdfs/{allPaths=**} {
      // Lecture : Admins uniquement
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (PDF, max 10MB)
      allow write: if isAdmin() && isPDF() && isPDFSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS GÉNÉRIQUES PAR MODULE
    // ==========================================
    // Chemin pour les documents archivés de chaque module
    
    match /documents/{module}/{memberId}/{fileName} {
      // Lecture : Admin ou propriétaire
      allow read: if isAdmin() || request.auth.uid == memberId;
      
      // Écriture : Admin uniquement
      allow write: if isAdmin();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // PREUVES DE PAIEMENT (PAYMENT-PROOFS)
    // ==========================================
    // Preuves de paiement uploadées par les admins
    // DONNÉES SENSIBLES - Accès restreint
    
    match /payment-proofs/{fileName} {
      // Lecture : Admins uniquement (données sensibles)
      allow read: if isAdmin();
      
      // Écriture : Admins uniquement avec validation (image, max 5MB)
      allow write: if isAdmin() && isImage() && isImageSizeValid();
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS CONTRATS (CONTRACTS-CI)
    // ==========================================
    // Documents uploadés pour les contrats et demandes d'adhésion
    // Supporte les chemins : contracts-ci/{memberId}/{contractId}/{fileName}
    // Utilisé pour les photos de profil et documents d'identité des demandes d'adhésion
    
    match /contracts-ci/{memberId}/{contractId}/{fileName} {
      // Lecture : Publique (nécessaire pour afficher les documents dans le formulaire)
      // La sécurité est gérée côté application
      allow read: if true;
      
      // Écriture : Publique avec validation (image, max 5MB)
      // Permet l'upload lors de l'inscription et les corrections
      allow write: if isImage() && isImageSizeValid();
      
      // Suppression : Publique (pour permettre le remplacement lors des corrections)
      // Sécurité gérée côté application
      allow delete: if true;
    }
    
    // ==========================================
    // RÈGLE PAR DÉFAUT
    // ==========================================
    // Refuser tout accès non explicitement autorisé
    
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
