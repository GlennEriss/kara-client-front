@startuml SEQ_ReouvrirDemande
title Séquence : Réouvrir une Demande Refusée (V2)
' Référence : ReouvrirDemande.puml (activité)
' Traçabilité : reopenedBy, reopenedAt, reopenedByName, reopenReason

actor "Admin" as Admin
participant "ReopenDemandModal\n(Component)" as Modal
participant "useCaisseSpecialeDemandMutations\n(Hook)" as Mutations
participant "CaisseSpecialeService\n(Service)" as Service
participant "CaisseSpecialeDemandRepository\n(Repository)" as Repo
participant "NotificationService\n(Service)" as Notif
database "Firestore" as Firestore

Admin -> Modal: Clique "Réouvrir" sur demande REJECTED
activate Modal

Modal --> Admin: Afficher modal avec infos membre, motif refus initial, champ motif réouverture

Admin -> Modal: Saisit motif de réouverture (min 10 car.)
Modal -> Modal: reopenDemandSchema.parse({ reason })

Admin -> Modal: Clique "Réouvrir"
activate Modal

Modal -> Mutations: reopen.mutateAsync({ demandId, reason })
activate Mutations

Mutations -> Service: reopenDemand(demandId, adminId, reason)
activate Service

Service -> Repo: getDemandById(demandId)
Repo -> Firestore: getDoc(demandId)
Firestore --> Repo: Demand
Repo --> Service: CaisseSpecialeDemand

Service -> Service: Vérifier status === 'REJECTED'

Service -> Repo: updateDemand(demandId, { status: PENDING, reopenedAt, reopenedBy, reopenedByName, reopenReason })
activate Repo
Repo -> Firestore: updateDoc(status, reopenedAt, reopenedBy, reopenedByName, reopenReason)
note right of Repo
  **Traçabilité** :
  reopenedBy = adminId
  reopenedAt = ServerTimestamp
  reopenedByName = nom admin
  reopenReason = motif saisi
end note
Firestore --> Repo: OK
deactivate Repo

Service -> Notif: createNotification(demande réouverte)
Notif -> Firestore: addDoc(notifications, ...)
Firestore --> Notif: OK

Service --> Mutations: CaisseSpecialeDemand
deactivate Service

Mutations -> Mutations: invalidateQueries(liste, stats, détail)
Mutations -> Mutations: toast.success('Demande réouverte')
Mutations --> Modal: Success
deactivate Mutations

Modal -> Modal: onClose()
Modal --> Admin: Fermer modal, toast, mise à jour UI (boutons Accepter/Refuser)
deactivate Modal

@enduml
