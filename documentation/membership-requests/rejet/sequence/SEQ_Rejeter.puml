@startuml SEQ_Rejeter
title Séquence : Rejeter une Demande d'Adhésion

actor "Admin" as Admin
participant "MembershipRequestActionsV2\n(Component)" as Actions
participant "RejectModalV2\n(Component)" as Modal
participant "useMembershipActionsV2\n(Hook)" as Hook
participant "MembershipServiceV2" as Service
participant "MembershipRepositoryV2\n(Repository)" as Repository
database "Firestore" as Firestore
participant "NotificationService" as Notif

Admin -> Actions: Cliquer "Rejeter"
activate Actions

Actions -> Modal: Ouvrir modal de rejet
activate Modal

Modal --> Admin: Formulaire motif de rejet

Admin -> Modal: Saisir motif + confirmer

Modal -> Hook: rejectMutation.mutate(\n{ requestId, adminId, reason })
activate Hook

Hook -> Service: rejectMembershipRequest(\n{ requestId, adminId, reason })
activate Service

Service -> Service: Validations :\n- Vérifier motif (10-500 caractères)\n- Vérifier existence demande

Service -> Repository: updateStatus(\nid, 'rejected', {\n  motifReject, processedBy, processedAt\n})
activate Repository

Repository -> Firestore: updateDoc(membership-requests/{id}, {\n  status: 'rejected',\n  processedBy: adminId,\n  processedAt: new Date(),\n  motifReject: reason.trim(),\n  updatedAt: serverTimestamp()\n})
activate Firestore
Firestore --> Repository: OK
deactivate Firestore

Repository --> Service: OK
deactivate Repository

Service -> Notif: createRejectionNotification(\nrequestId, adminId, reason,\nmemberName)
activate Notif
Note right of Notif: Notification Firestore\npour admins (type: membership_rejected)
Notif -> Firestore: Créer notification\npour tous les admins
Firestore --> Notif: OK
Notif --> Service: OK
deactivate Notif

Note right of Service: ⚠️ Notification email/SMS\nautomatique au demandeur\nest optionnelle/non prioritaire\n(via Cloud Function Trigger\nonMembershipRequestRejected)\n\n✅ Bouton WhatsApp manuel\ndisponible dans actions\npost-rejet pour informer\ndirectement le demandeur
Service --> Hook: void
deactivate Service

Hook -> Hook: invalidateQueries([\n  'membershipRequests',\n  'membershipRequest', requestId,\n  'notifications'\n])

Hook --> Modal: success
deactivate Hook

Modal --> Admin: Toast "Demande rejetée"
Modal -> Modal: Fermer modal

deactivate Modal
deactivate Actions

@enduml