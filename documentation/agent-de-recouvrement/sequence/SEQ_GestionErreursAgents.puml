@startuml SEQ_GestionErreursAgents
title Diagramme de séquence : Gestion des erreurs – Module Agent de recouvrement

actor Admin
participant "Modal\n/Formulaire" as UI
participant "Hook" as Hook
participant "Service" as Service
participant "Repository" as Repo
database "Firestore" as DB

== Erreur de validation (Zod) ==
Admin -> UI : soumet formulaire (champs invalides)
UI -> UI : agentRecouvrementSchema.validate()
UI --> Admin : erreurs sous les champs, bouton désactivé

== Agent introuvable (404) ==
Admin -> UI : accède détails / modifie / désactive agent
UI -> Hook : getById(agentId) / update(agentId) / deactivate(agentId)
Hook -> Repo : getById(agentId)
Repo -> DB : getDoc(agentsRecouvrement/agentId)
DB --> Repo : null (doc supprimé)
Repo --> Hook : null
Hook --> UI : error "Agent introuvable"
UI --> Admin : toast.error "Agent introuvable" + fermer modal / bouton "Retour"

== Erreur réseau / Firestore ==
Admin -> UI : crée / modifie / désactive agent
UI -> Hook : create() / update() / deactivate()
Hook -> Service : ...
Service -> Repo : ...
Repo -> DB : addDoc() / updateDoc()
DB --> Repo : NetworkError / PermissionDenied / InternalError
Repo --> Service : throw
Service --> Hook : isError=true, error
Hook --> UI : error
UI --> Admin : toast.error "Erreur de connexion" / "Droits insuffisants" / "Erreur serveur"
UI --> Admin : bouton "Réessayer" (si applicable)

== Erreur règle métier (doublon) ==
Admin -> UI : crée agent (numéro pièce existant)
UI -> Hook : create(data)
Hook -> Service : createAgent(data)
Service -> Repo : create(data)
Repo -> DB : addDoc()
Note over Repo, DB : vérification unicité numéro pièce
DB --> Repo : doublon détecté
Repo --> Service : throw DuplicateError
Service --> Hook : error
Hook --> UI : error "Un agent avec ce numéro existe déjà"
UI --> Admin : afficher erreur, rester dans modal

== Recherche : minimum 2 caractères ==
Admin -> UI : saisit 1 caractère dans recherche
UI -> UI : debounce, query.length < 2
UI --> Admin : afficher "Minimum 2 caractères", pas de requête

@enduml
