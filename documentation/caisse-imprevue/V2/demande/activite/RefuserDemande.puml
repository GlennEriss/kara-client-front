@startuml RefuserDemande
title Workflow : Refuser une Demande (V2)

start

:Admin clique "Refuser" sur une demande PENDING;

:Ouvrir RejectDemandModalV2 :
- Modal responsive (max-w-3xl)
- Scroll si contenu long;

:Afficher toutes les informations du demandeur :
- Nom complet
- Téléphone
- Email
- Matricule;

:Afficher section "Motif de la demande" :
- Texte complet du motif
- Style textarea (readonly);

:Afficher section "Contact d'urgence" :
- Nom complet
- Téléphones
- Lien de parenté
- Type et numéro de document
- Photo document (si présente);

:Afficher section "Résumé de la demande" :
- Forfait sélectionné
- Fréquence (DAILY / MONTHLY)
- Montant mensuel
- Durée totale
- Date souhaitée;

:Champ "Motif de refus" :
- Textarea obligatoire
- Min 10 caractères
- Max 500 caractères
- Compteur de caractères;

if (Admin saisit motif ?) then (oui)
  :Valider longueur :
  - Min 10 caractères ?;
  
  if (Validation OK ?) then (oui)
    :Bouton "Refuser la demande" activé;
  else (non)
    :Afficher erreur "Minimum 10 caractères";
    :Bouton "Refuser" désactivé;
  endif
endif

if (Admin clique "Refuser la demande" ?) then (oui)
  :Valider formulaire modal :
  - Motif de refus rempli
  - Longueur >= 10 caractères;
  
  if (Validation réussie ?) then (oui)
    :Hook useRejectDemand :
    - Optimistic update (mise à jour immédiate UI)
    - Service.rejectDemand(demandId, reason);
    
    :Repository.update() :
    - Firestore.updateDoc()
    - status = 'REJECTED'
    - decisionReason = reason
    - rejectedBy = currentAdminId
    - rejectedAt = now()
    - decisionMadeBy = currentAdminId
    - decisionDate = now();
    
    note right
      rejectedBy : ID de l'admin qui refuse
      rejectedAt : Date/heure de refus
      decisionMadeBy et decisionDate : pour compatibilité
    end note
    
    :Invalider cache :
    - Invalider liste demandes
    - Invalider stats
    - Invalider détails;
    
    :Fermer le modal;
    
    :Afficher toast "Demande refusée";
    
    :Mettre à jour l'UI :
    - Statut changé à REJECTED
    - Badge rouge
    - Boutons "Réouvrir" et "Supprimer" apparaissent;
    
    stop
  else (non)
    :Afficher erreurs de validation;
    :Rester dans le modal;
  endif
elseif (Admin clique "Annuler" ?) then (oui)
  :Fermer le modal;
  stop
endif

note right
  **Fonctionnalités clés** :
  - Modal avec toutes les informations
  - Validation stricte motif (min 10 caractères)
  - Optimistic update pour UX fluide
  - Invalidation cache intelligente
  - Toast de confirmation
  - Boutons "Réouvrir" et "Supprimer" disponibles après refus
  
  **Traçabilité** :
  - rejectedBy : ID de l'admin qui a refusé la demande
  - rejectedAt : Date et heure précise du refus
  - Ces attributs permettent d'auditer qui a fait quoi et quand
end note

@enduml
