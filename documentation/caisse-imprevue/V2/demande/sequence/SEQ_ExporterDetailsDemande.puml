@startuml SEQ_ExporterDetailsDemande
title S√©quence : Exporter les D√©tails d'une Demande en PDF (V2)

actor "Admin" as Admin
participant "DemandDetailV2\n(Component)" as Detail
participant "useExportDemandDetails\n(Hook)" as ExportHook
participant "DemandExportService\n(Service)" as Service
participant "DemandCIRepository\n(Repository)" as Repo
database "Firestore" as Firestore
participant "React Query\n(Cache)" as QueryCache
participant "jsPDF\n(Library)" as PDFGen

' ============================================
' D√âCLENCHEMENT EXPORT
' ============================================
Admin -> Detail: Clique bouton "Export PDF"
activate Detail

Detail -> Detail: V√©rifier que demand est charg√©

alt Demande non charg√©e
    Detail --> Admin: toast.error("Impossible d'exporter : demande non charg√©e")
    stop
end

Detail -> Detail: Afficher √©tat loading (spinner + "G√©n√©ration...")

Detail -> ExportHook: useExportDemandDetails(demandId)
activate ExportHook

' ============================================
' R√âCUP√âRATION DES DONN√âES
' ============================================
ExportHook -> Service: exportDemandDetails(demandId)
activate Service

Service -> QueryCache: queryKey: ['demand-detail', demandId]
QueryCache -> QueryCache: V√©rifier cache (staleTime: 10 min)

alt Cache pr√©sent et frais
    QueryCache --> Service: Demand depuis cache
else Cache absent ou stale
    Service -> Repo: getById(demandId)
    activate Repo
    
    Repo -> Firestore: getDoc(doc('caisseImprevueDemands', demandId))
    Firestore --> Repo: DocumentSnapshot
    
    Repo -> Repo: Transformer document ‚Üí CaisseImprevueDemand
    
    Repo --> Service: CaisseImprevueDemand
    deactivate Repo
    
    Service -> QueryCache: Mettre en cache (10 min)
    QueryCache --> Service: Cache mis √† jour
end

' ============================================
' CONSTRUCTION DES DONN√âES PDF
' ============================================
Service -> Service: Construire objet donn√©es PDF :
Service -> Service: - En-t√™te (logo, titre, num√©ro)
Service -> Service: - Statut (badge, dates, cr√©ateur)
Service -> Service: - Informations demandeur
Service -> Service: - Motif de la demande
Service -> Service: - Forfait s√©lectionn√©
Service -> Service: - Contact d'urgence
Service -> Service: - Plan de remboursement (tableau)
Service -> Service: - Historique (chronologie)

' ============================================
' G√âN√âRATION DU PDF
' ============================================
Service -> PDFGen: new jsPDF({ format: 'a4', orientation: 'portrait' })
activate PDFGen

PDFGen -> PDFGen: Cr√©er document A4 portrait
PDFGen --> Service: Document jsPDF

Service -> PDFGen: setFontSize(14)
Service -> PDFGen: text("D√âTAILS DE LA DEMANDE CAISSE IMPR√âVUE", x, y)

Service -> PDFGen: addImage(logoKARA, 'PNG', x, y, width, height)
note right of PDFGen: Si logo disponible

Service -> PDFGen: text("Demande #" + demandId, x, y)

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üìä STATUT", x, y)
Service -> PDFGen: text("Statut : " + demand.status, x, y)
Service -> PDFGen: text("Date de cr√©ation : " + formatDate(demand.createdAt), x, y)
Service -> PDFGen: text("Cr√©√©e par : " + demand.createdBy, x, y)

alt demand.acceptedAt
    Service -> PDFGen: text("Accept√©e le : " + formatDate(demand.acceptedAt), x, y)
    Service -> PDFGen: text("Par : " + demand.acceptedBy, x, y)
end

alt demand.rejectedAt
    Service -> PDFGen: text("Refus√©e le : " + formatDate(demand.rejectedAt), x, y)
    Service -> PDFGen: text("Par : " + demand.rejectedBy, x, y)
    Service -> PDFGen: text("Motif : " + demand.decisionReason, x, y)
end

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üë§ INFORMATIONS DU DEMANDEUR", x, y)
Service -> PDFGen: text("Nom : " + demand.memberLastName, x, y)
Service -> PDFGen: text("Pr√©nom : " + demand.memberFirstName, x, y)
Service -> PDFGen: text("T√©l√©phone : " + demand.memberPhone, x, y)
Service -> PDFGen: text("Email : " + demand.memberEmail, x, y)
Service -> PDFGen: text("Matricule : " + demand.memberMatricule, x, y)

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üìù MOTIF DE LA DEMANDE", x, y)
Service -> PDFGen: text(demand.reason, x, y, { maxWidth: pageWidth - margins })

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üí∞ FORFAIT S√âLECTIONN√â", x, y)
Service -> PDFGen: text("Forfait : " + demand.subscriptionCI.name, x, y)
Service -> PDFGen: text("Montant : " + demand.amount + " FCFA/" + frequency, x, y)
Service -> PDFGen: text("Dur√©e : " + demand.duration + " mois", x, y)
Service -> PDFGen: text("Fr√©quence : " + demand.paymentFrequency, x, y)
Service -> PDFGen: text("Date souhait√©e : " + formatDate(demand.desiredStartDate), x, y)

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üìû CONTACT D'URGENCE", x, y)
Service -> PDFGen: text("Nom : " + demand.emergencyContact.lastName, x, y)
Service -> PDFGen: text("Pr√©nom : " + demand.emergencyContact.firstName, x, y)
Service -> PDFGen: text("T√©l√©phone : " + demand.emergencyContact.phone, x, y)
Service -> PDFGen: text("Lien : " + demand.emergencyContact.relationship, x, y)
Service -> PDFGen: text("Type pi√®ce : " + demand.emergencyContact.identityDocumentType, x, y)
Service -> PDFGen: text("Num√©ro : " + demand.emergencyContact.identityDocumentNumber, x, y)

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üíµ PLAN DE REMBOURSEMENT", x, y)

Service -> PDFGen: autoTable({
Service -> PDFGen:   head: [['Mois', 'Date', 'Montant', 'Cumul√©']],
Service -> PDFGen:   body: repaymentSchedule.map((v, i) => [
Service -> PDFGen:     i + 1,
Service -> PDFGen:     formatDate(v.date),
Service -> PDFGen:     v.amount + ' FCFA',
Service -> PDFGen:     v.cumulative + ' FCFA'
Service -> PDFGen:   ]).concat([['Total', demand.duration + ' mois', totalAmount + ' FCFA', '']]),
Service -> PDFGen:   startY: currentY,
Service -> PDFGen:   styles: { fontSize: 10 }
Service -> PDFGen: })

Service -> PDFGen: setFontSize(12)
Service -> PDFGen: text("üìã HISTORIQUE", x, y)

loop Pour chaque action dans historique
    Service -> PDFGen: text("‚Ä¢ " + formatDate(action.date) + " - " + action.description, x, y)
end

Service -> PDFGen: setFontSize(10)
Service -> PDFGen: text("Document g√©n√©r√© le " + formatDate(now()), x, bottomY)
Service -> PDFGen: text("KARA - Caisse Impr√©vue", x, bottomY + 5)

PDFGen --> Service: Document PDF complet
deactivate PDFGen

Service -> Service: G√©n√©rer Blob PDF
Service --> ExportHook: Blob PDF
deactivate Service

ExportHook --> Detail: Blob PDF
deactivate ExportHook

' ============================================
' T√âL√âCHARGEMENT
' ============================================
Detail -> Detail: G√©n√©rer nom fichier :
Detail -> Detail: "demande_" + demandId + "_" + YYYYMMDD_HHMMSS + ".pdf"

Detail -> Detail: Cr√©er lien <a> avec download
Detail -> Detail: D√©clencher click() programmatique
Detail -> Detail: Supprimer lien apr√®s t√©l√©chargement

Detail -> Detail: Restaurer √©tat normal bouton (ic√¥ne + "Export PDF")

Detail -> Detail: toast.success("PDF g√©n√©r√© avec succ√®s")

Detail --> Admin: T√©l√©chargement fichier d√©clench√©

deactivate Detail

note right of Service
  **Fonctionnalit√©s export** :
  - Export direct (pas de modal)
  - G√©n√©ration c√¥t√© client (jsPDF)
  - Utilise cache React Query si disponible
  - PDF complet avec toutes les informations
  - Tableau format√© avec jspdf-autotable
  - Historique complet
  - Format A4 portrait professionnel
end note

note right of PDFGen
  **Biblioth√®que** :
  - jsPDF pour g√©n√©ration PDF
  - jspdf-autotable pour tableaux
  - Format A4 portrait
  - Marges 20mm
  - Police Arial 10pt/12pt/14pt
end note

@enduml
