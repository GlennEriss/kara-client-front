@startuml CLASSES_SHARED
skinparam packageStyle rectangle
skinparam class {
  BackgroundColor LightYellow
  BorderColor DarkBlue
  ArrowColor DarkBlue
}

title Diagramme de Classes - Infrastructure Partagée (Shared)

' ============================================
' CLASSE : USER (Utilisateur)
' ============================================
class User {
  + id: string
  + matricule: string
  + lastName: string
  + firstName: string
  + birthDate: string
  + birthPlace?: string
  + contacts: string[]
  + gender: string
  + email?: string
  + nationality: string
  + hasCar: boolean
  + address?: Address
  + companyName?: string
  + profession?: string
  + photoURL?: string
  + photoPath?: string
  + identityDocument?: string
  + identityDocumentNumber?: string
  + subscriptions: string[]
  + roles: UserRole[]
  + isActive: boolean
  + createdAt: Date
  + updatedAt: Date
  + createdBy?: string
  + updatedBy?: string
}

' ============================================
' CLASSE : ADDRESS (Adresse)
' ============================================
class Address {
  + province: string
  + city: string
  + district: string
  + arrondissement: string
  + additionalInfo?: string
}

' ============================================
' CLASSE : DOCUMENT (Document)
' ============================================
class Document {
  + id?: string
  + type: DocumentType
  + format: DocumentFormat
  + libelle: string
  + path: string
  + url: string
  + size: number
  + memberId: string
  + contractId?: string
  + createdBy: string
  + updatedBy: string
  + createdAt: Date
  + updatedAt: Date
}

' ============================================
' CLASSE : COMPANY (Entreprise)
' ============================================
class Company {
  + id: string
  + name: string
  + normalizedName: string
  + address?: CompanyAddress
  + industry?: string
  + employeeCount?: number
  + createdAt: Date
  + updatedAt: Date
  + createdBy: string
}

' ============================================
' CLASSE : COMPANY_ADDRESS (Adresse Entreprise)
' ============================================
class CompanyAddress {
  + province?: string
  + city?: string
  + district?: string
}

' ============================================
' CLASSE : PROFESSION (Profession)
' ============================================
class Profession {
  + id: string
  + name: string
  + normalizedName: string
  + category?: string
  + createdAt: Date
  + updatedAt: Date
  + createdBy?: string
  + updatedBy?: string
}

' ============================================
' CLASSE : NOTIFICATION (Notification)
' ============================================
class Notification {
  + id: string
  + module: NotificationModule
  + entityId: string
  + type: NotificationType
  + title: string
  + message: string
  + isRead: boolean
  + createdAt: Date
  + scheduledAt?: Date
  + sentAt?: Date
  + metadata?: NotificationMetadata
  + requestId?: string
  + memberId?: string
  + contractId?: string
}

class NotificationMetadata {
  + memberId?: string
  + memberFirstName?: string
  + memberLastName?: string
  + memberName?: string
  + adminId?: string
  + adminName?: string
  + status?: string
  + motifReject?: string
  + reopenReason?: string
  + birthDate?: string
  + daysUntil?: number
  + age?: number
  + notificationDate?: string
  + processedAt?: string
  + processedBy?: string
  + reopenedAt?: string
  + reopenedBy?: string
  + deletedAt?: string
  + deletedBy?: string
  + [key: string]: any
}

' ============================================
' CLASSE : NOTIFICATION_SERVICE
' ============================================
class NotificationService {
  - repository: NotificationRepository
  + createNotification(params: CreateNotificationParams): Promise<Notification>
  + createBirthdayNotification(memberId, firstName, lastName, birthDate, daysUntil): Promise<Notification>
  + createMembershipRequestNotification(requestId, type, memberName?, status?): Promise<Notification>
  + createRejectionNotification(requestId, memberName, adminName, adminId, motif, processedAt): Promise<Notification>
  + createReopeningNotification(requestId, memberName, adminName, adminId, reason, reopenedAt, prevMotif?): Promise<Notification>
  + createDeletionNotification(requestId, memberName, matricule, adminName, adminId, deletedAt, prevMotif?): Promise<Notification>
  + getUnreadCount(): Promise<number>
  + getUnreadNotifications(limit?: number): Promise<Notification[]>
  + getNotifications(filters?: NotificationFilters): Promise<Notification[]>
  + markAsRead(id: string): Promise<void>
  + markAllAsRead(): Promise<void>
  + markAsReadByModule(module: NotificationModule): Promise<void>
  + formatNotificationMessage(type, metadata): string
  + shouldCreateNotification(type, context): boolean
}

class NotificationRepository {
  + create(notification: Omit<Notification, 'id' | 'createdAt'>): Promise<Notification>
  + getById(id: string): Promise<Notification | null>
  + update(id: string, updates: Partial<Notification>): Promise<Notification | null>
  + delete(id: string): Promise<void>
  + getUnreadCount(): Promise<number>
  + getUnreadNotifications(limit?: number): Promise<Notification[]>
  + getNotificationsByModule(module: NotificationModule, filters?: NotificationFilters): Promise<Notification[]>
  + getPaginatedNotifications(filters?, page?, limit?): Promise<PaginatedNotifications>
  + markAsRead(id: string): Promise<void>
  + markAllAsRead(): Promise<void>
  + markAsReadByModule(module: NotificationModule): Promise<void>
  + getScheduledNotifications(beforeDate: Date): Promise<Notification[]>
  + markAsSent(id: string): Promise<void>
}

class NotificationFilters {
  + module?: NotificationModule
  + type?: NotificationType
  + isRead?: boolean
  + dateFrom?: Date
  + dateTo?: Date
}

' ============================================
' HOOKS : NOTIFICATIONS
' ============================================
class useNotifications {
  + filters?: NotificationFilters
  + data: Notification[] | undefined
  + isLoading: boolean
  + isError: boolean
}

class useUnreadNotifications {
  + limit?: number
  + data: Notification[] | undefined
  + isLoading: boolean
}

class useUnreadCount {
  + data: number | undefined
  + isLoading: boolean
}

class useMarkNotificationAsRead {
  + mutate(id: string): void
  + isPending: boolean
}

class useMarkAllNotificationsAsRead {
  + mutate(): void
  + isPending: boolean
}

' ============================================
' CLASSE : AUDIT_LOG (Log d'audit)
' ============================================
class AuditLog {
  + id: string
  + action: string
  + requestId?: string
  + matricule?: string
  + memberName?: string
  + deletedBy?: string
  + deletedByName?: string
  + deletedAt?: Date
  + reason?: string
  + metadata?: Record<string, any>
  + createdAt: Date
}

' ============================================
' TYPES ENUMERÉS
' ============================================
enum UserRole {
  Adherant
  Bienfaiteur
  Sympathisant
  Admin
  SuperAdmin
  Secretary
}

enum DocumentType {
  ADHESION
  ADHESION_CS
  ADHESION_CI
  CANCELED_CS
  CANCELED_CI
  FINISHED_CS
  FINISHED_CI
  SUPPORT_CI
  EARLY_REFUND_CI
  FINAL_REFUND_CI
  EARLY_REFUND_CS
  FINAL_REFUND_CS
  CHARITY_EVENT_MEDIA
  CHARITY_CONTRIBUTION_RECEIPT
  CHARITY_EVENT_REPORT
  PLACEMENT_CONTRACT
  PLACEMENT_COMMISSION_PROOF
  PLACEMENT_EARLY_EXIT_QUITTANCE
  PLACEMENT_FINAL_QUITTANCE
  PLACEMENT_EARLY_EXIT_ADDENDUM
  PLACEMENT_EARLY_EXIT_DOCUMENT
  CREDIT_SPECIALE_CONTRACT
  CREDIT_SPECIALE_CONTRACT_SIGNED
  CREDIT_SPECIALE_RECEIPT
  CREDIT_SPECIALE_DISCHARGE
}

enum DocumentFormat {
  pdf
  word
  excel
  image
  text
}

enum NotificationModule {
  memberships
  vehicule
  caisse_speciale
  caisse_imprevue
  bienfaiteur
  placement
  credit_speciale
}

enum NotificationType {
  birthday_reminder
  new_request
  status_update
  reminder
  contract_expiring
  payment_due
  contract_created
  contract_finished
  contract_canceled
  commission_due_reminder
  commission_overdue
  placement_activated
  corrections_requested
  corrections_submitted
  security_code_expired
  security_code_expiring_soon
  security_code_renewed
  membership_approved
  membership_rejected
  membership_reopened
  membership_deleted
  ...
}

' ============================================
' RELATIONS
' ============================================

' User contient une Address (composition)
User *-- Address : contains

' User peut avoir plusieurs Documents (agrégation)
User "1" --> "*" Document : has

' User peut avoir une Company (référence)
User --> Company : works_at

' User peut avoir une Profession (référence)
User --> Profession : has_profession

' User peut recevoir plusieurs Notifications (agrégation)
User "1" --> "*" Notification : receives

' Company a une CompanyAddress (composition)
Company *-- CompanyAddress : has_address

' Document peut être lié à une entité (User, Contract, etc.)
' (relation via relatedEntityType/relatedEntityId)

note right of User
  **Collection Firestore:** users
  Clé primaire: id (égal à UID Firebase et matricule)
end note

note right of Document
  **Collection Firestore:** documents
  Clé primaire: id (généré: MK_{type}_{memberId}_{ddMMyy}_{HHmm})
  
  **Types de documents:**
  - ADHESION: PDF d'adhésion (créé lors de l'approbation)
  - ADHESION_CS: Contrat d'adhésion Caisse Spéciale
  - ADHESION_CI: Contrat d'adhésion Caisse Imprévue
  - Autres types selon module
  
  **Workflow d'approbation:**
  1. Admin upload PDF d'adhésion (Firebase Storage)
  2. Cloud Function archive dans collection "documents"
  3. Document créé avec type='ADHESION', memberId=matricule
  4. URL et path stockés depuis Firebase Storage
  
  **Relations:**
  - memberId: Référence vers User (matricule)
  - contractId: Optionnel (pour documents liés à un contrat)
end note

note right of Company
  **Collection Firestore:** companies
  Recherche par normalizedName
end note

note right of Profession
  **Collection Firestore:** professions
  Recherche par normalizedName
end note

note right of Notification
  **Collection Firestore:** notifications
  Index sur: isRead, createdAt, module, type, scheduledAt, sentAt
  
  **Types de notifications:**
  - birthday_reminder: Anniversaire (J-2, J, J+1)
  - new_request: Nouvelle demande d'adhésion
  - status_update: Changement de statut
  - membership_rejected: Demande rejetée
  - membership_reopened: Dossier réouvert
  - membership_deleted: Dossier supprimé
  - commission_overdue: Commission en retard (Placement)
  - payment_due: Paiement dû
  - contract_expiring: Contrat expire bientôt
  - demand_created/approved/rejected: Demandes CI/CS
  
  **Anti-doublon (anniversaires):**
  Vérifie metadata.memberId + notificationDate + daysUntil
end note

note right of NotificationService
  **Service métier pour les notifications**
  
  **Package:** src/services/notifications/
  
  **Responsabilités:**
  - Création de notifications selon les règles métier
  - Formatage des messages
  - Vérification anti-doublon
  - Lecture et marquage comme lu
  
  **Utilisé par:**
  - MembershipServiceV2 (rejet, réouverture, approbation)
  - Cloud Functions (anniversaires, rappels, échéances)
end note

note right of NotificationRepository
  **Repository Firestore pour notifications**
  
  **Package:** src/repositories/notifications/
  
  **Collection:** notifications
  
  **Méthodes clés:**
  - getUnreadCount(): Utilise getCountFromServer()
  - markAllAsRead(): Batch update
  - getScheduledNotifications(): Pour jobs Cloud Functions
end note

' Relations Notifications
NotificationService --> NotificationRepository : uses
Notification *-- NotificationMetadata : contains
useNotifications ..> NotificationService : uses
useUnreadNotifications ..> NotificationService : uses
useUnreadCount ..> NotificationService : uses
useMarkNotificationAsRead ..> NotificationService : uses
useMarkAllNotificationsAsRead ..> NotificationService : uses

note right of AuditLog
  **Collection Firestore:** audit-logs
  Clé primaire: id (auto-généré)
  
  **Utilisation:**
  - Logs d'audit pour actions critiques (suppression définitive)
  - Créé par Cloud Function deleteMembershipRequest
  - Contient métadonnées complètes pour traçabilité
  
  **Champs principaux:**
  - action: Type d'action (ex: 'membership_request_deleted')
  - requestId: ID de la demande concernée
  - deletedBy: ID de l'admin qui a supprimé
  - metadata: Données supplémentaires (statut, motifReject, etc.)
end note

@enduml
