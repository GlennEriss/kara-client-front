@startuml Séquence - Chargement liste
title Séquence de chargement de la liste des membres (V2)

actor Admin
participant "MembershipsListPage" as Page
participant "useMembershipsListV2" as Hook
participant "MembersRepositoryV2" as Repo
participant "MembershipsListService" as Service
participant "getMembers (member.db.ts)" as GetMembers
participant Firestore

Admin -> Page: Accède à /memberships
activate Page
Page -> Hook: useMembershipsListV2({ filters, page, limit, tab })
activate Hook

Hook -> Service: buildFiltersForTab(baseFilters, tab)
Service --> Hook: effectiveFilters
activate Service
deactivate Service

Hook -> Repo: getAll(effectiveFilters, page, limit, cursor?)
activate Repo
Repo -> GetMembers: getMembers(filters, page, limit, cursor)
activate GetMembers

GetMembers -> Firestore: query(users, constraints) + getCountFromServer()
activate Firestore
Firestore --> GetMembers: querySnapshot + countSnapshot
deactivate Firestore

GetMembers -> GetMembers: Paralléliser getMemberWithSubscription() avec Promise.all()
GetMembers -> Firestore: getDocs(subscriptions) pour chaque membre (batch)
activate Firestore
Firestore --> GetMembers: subscriptions[]
deactivate Firestore

GetMembers --> Repo: PaginatedMembers { data, pagination { totalItems, totalPages, nextCursor } }
deactivate GetMembers
Repo --> Hook: PaginatedMembers
deactivate Repo

Hook -> Service: calculateStats(paginated)
activate Service
Service --> Hook: MembershipStats
deactivate Service

Hook --> Page: { data, stats, isLoading: false, goToNextPage, goToPrevPage, canGoNext, canGoPrev }
deactivate Hook

Page -> Page: Rend composants :
- MembershipsListStats
- MembershipsListHeader
- MembershipsListTabs
- MembershipsListFilters
- MembershipsListLayout
- MembershipsListPagination
deactivate Page

@enduml
